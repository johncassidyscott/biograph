<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#6366f1" />
<meta name="description" content="Interactive knowledge graph for drugs, diseases, clinical trials, and biomedical entities" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="BioGraph" />
<link rel="manifest" href="/static/manifest.json?v=2" />
<link rel="icon" type="image/svg+xml" href="/static/icon.svg?v=2" />
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<title>BioGraph - Life Sciences Knowledge Graph</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --bg-gradient-1: #667eea;
    --bg-gradient-2: #764ba2;
    --bg-gradient-3: #f093fb;
    --bg-gradient-4: #4facfe;
    --text-primary: #333;
    --text-secondary: #666;
    --text-white: white;
    --glass-bg: rgba(255, 255, 255, 0.95);
    --glass-border: rgba(255, 255, 255, 0.3);
    --card-bg: rgba(255, 255, 255, 0.95);
    --input-bg: white;
    --shadow: rgba(0, 0, 0, 0.1);
    --shadow-hover: rgba(0, 0, 0, 0.15);
    --accent-primary: #667eea;
    --accent-secondary: #764ba2;
}

body.dark-mode {
    --bg-gradient-1: #1a1a2e;
    --bg-gradient-2: #16213e;
    --bg-gradient-3: #0f3460;
    --bg-gradient-4: #533483;
    --text-primary: #e0e0e0;
    --text-secondary: #b0b0b0;
    --text-white: #f5f5f5;
    --glass-bg: rgba(30, 30, 45, 0.95);
    --glass-border: rgba(255, 255, 255, 0.1);
    --card-bg: rgba(30, 30, 45, 0.95);
    --input-bg: #2a2a3e;
    --shadow: rgba(0, 0, 0, 0.3);
    --shadow-hover: rgba(0, 0, 0, 0.5);
}

@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes slideInRight {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

@keyframes glow {
    0%, 100% { filter: drop-shadow(0 0 5px var(--accent-primary)); }
    50% { filter: drop-shadow(0 0 20px var(--accent-primary)); }
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(-45deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3), var(--bg-gradient-4));
    background-size: 400% 400%;
    animation: gradient 15s ease infinite;
    min-height: 100vh;
    padding: 20px;
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
}

/* Glassmorphism */
.glass {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px var(--shadow);
    transition: all 0.3s ease;
}

/* Dark mode toggle */
.dark-mode-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: var(--glass-bg);
    border: 2px solid var(--glass-border);
    border-radius: 50px;
    padding: 12px 24px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px var(--shadow);
    transition: all 0.3s ease;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
    font-weight: 600;
}

.dark-mode-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px var(--shadow-hover);
}

.dark-mode-toggle .icon {
    font-size: 1.3em;
    animation: glow 2s ease-in-out infinite;
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 16px 24px;
    box-shadow: 0 8px 32px var(--shadow-hover);
    border-left: 4px solid var(--accent-primary);
    animation: slideInRight 0.3s ease;
    min-width: 300px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
    font-weight: 500;
}

.toast.success { border-left-color: #10b981; }
.toast.error { border-left-color: #ef4444; }
.toast.info { border-left-color: #3b82f6; }
.toast .icon { font-size: 1.5em; }

/* Keyboard shortcut hint */
.kbd {
    display: inline-block;
    padding: 3px 8px;
    background: var(--input-bg);
    border: 1px solid var(--glass-border);
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.85em;
    box-shadow: 0 2px 4px var(--shadow);
}

header {
    text-align: center;
    color: var(--text-white);
    margin-bottom: 40px;
    padding: 60px 20px;
    animation: fadeIn 0.8s ease;
    position: relative;
}

.header-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
}

header h1 {
    font-size: 4em;
    font-weight: 800;
    background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

header p {
    font-size: 1.4em;
    opacity: 0.95;
    font-weight: 300;
    letter-spacing: 0.5px;
}

.search-hero {
    max-width: 800px;
    margin: 30px auto 0;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 20px 60px 20px 24px;
    font-size: 18px;
    border: none;
    border-radius: 50px;
    background: var(--glass-bg);
    color: var(--text-primary);
    box-shadow: 0 10px 40px var(--shadow);
    transition: all 0.3s;
}

.search-input:focus {
    outline: none;
    box-shadow: 0 10px 60px var(--shadow-hover);
    transform: translateY(-2px);
}

.search-input::placeholder {
    color: var(--text-secondary);
}

.search-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 12px 24px;
    border-radius: 50px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.search-btn:hover {
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    transform: translateY(-50%) scale(1.05);
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
    animation: fadeIn 1s ease 0.2s both;
}

.stat-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px var(--shadow);
    border: 1px solid var(--glass-border);
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
}

.stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 40px var(--shadow-hover);
    border-color: var(--accent-primary);
}

.stat-card .icon {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.stat-card .number {
    font-size: 3em;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
}

.stat-card .label {
    font-size: 0.95em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 600;
}

.main-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 40px;
    box-shadow: 0 8px 32px var(--shadow);
    border: 1px solid var(--glass-border);
    animation: fadeIn 1.2s ease 0.4s both;
}

/* Export button */
.export-btn {
    position: relative;
    overflow: hidden;
}

.export-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.export-btn:active::after {
    width: 300px;
    height: 300px;
}

.tabs {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    flex-wrap: wrap;
}

.tab {
    padding: 15px 30px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: #666;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s;
}

.tab:hover {
    color: #667eea;
    transform: none;
    box-shadow: none;
}

.tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

h2 {
    color: var(--text-primary);
    margin-bottom: 25px;
    font-size: 2em;
    font-weight: 700;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 25px;
}

.quick-btn {
    padding: 15px 20px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.quick-btn:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.controls {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

select, input, button {
    padding: 14px 22px;
    font-size: 15px;
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 12px;
    transition: all 0.3s;
    font-family: inherit;
}

select, input {
    background: var(--input-bg);
    color: var(--text-primary);
}

select:focus, input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

select option {
    background: var(--input-bg);
    color: var(--text-primary);
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

button:active {
    transform: translateY(0);
}

.results-container {
    min-height: 200px;
}

.entity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.entity-card {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border: 2px solid rgba(102, 126, 234, 0.1);
    border-radius: 15px;
    padding: 20px;
    transition: all 0.3s;
}

.entity-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
    border-color: #667eea;
}

.entity-card .entity-name {
    font-size: 1.2em;
    font-weight: 700;
    color: #333;
    margin-bottom: 8px;
}

.entity-card .entity-id {
    font-size: 0.85em;
    color: #667eea;
    font-family: monospace;
    background: rgba(102, 126, 234, 0.1);
    padding: 4px 10px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 8px;
}

.entity-card .entity-kind {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.kind-drug { background: #e8f4fd; color: #1976d2; }
.kind-disease { background: #ffe8e8; color: #d32f2f; }
.kind-target { background: #fff3e0; color: #f57c00; }
.kind-trial { background: #f3e5f5; color: #7b1fa2; }
.kind-company { background: #e0f2f1; color: #00796b; }
.kind-publication { background: #fce4ec; color: #c2185b; }

.edge-card {
    background: white;
    border-left: 4px solid #667eea;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s;
}

.edge-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transform: translateX(5px);
}

.edge-card .edge-predicate {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    margin: 10px 0;
}

.edge-card .entity-label {
    font-weight: 600;
    color: #333;
    transition: all 0.3s;
}

.edge-card .entity-label[onclick]:hover {
    color: #667eea;
    text-decoration-color: #667eea !important;
}

.entity-card[onclick] {
    cursor: pointer;
}

.entity-card[onclick]:hover {
    transform: translateY(-8px) scale(1.02);
}

pre {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    overflow: auto;
    max-height: 600px;
    font-size: 13px;
    line-height: 1.7;
    border: 1px solid #e0e0e0;
}

.loading {
    text-align: center;
    color: #667eea;
    font-style: italic;
    padding: 60px 20px;
    font-size: 1.1em;
}

.loading::after {
    content: '...';
    animation: pulse 1.5s infinite;
}

.footer {
    text-align: center;
    color: white;
    padding: 40px 20px;
    font-size: 0.95em;
}

.footer a {
    color: white;
    text-decoration: none;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    transition: all 0.3s;
}

.footer a:hover {
    border-bottom-color: white;
}

.about-section {
    line-height: 1.9;
    color: #555;
}

.about-section h3 {
    margin: 30px 0 15px;
    color: #667eea;
    font-size: 1.4em;
}

.about-section ul {
    list-style: none;
    padding: 0;
}

.about-section li {
    padding: 10px 0;
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
}

.about-section li:last-child {
    border-bottom: none;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin: 30px 0;
}

.feature-box {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    padding: 25px;
    border-radius: 15px;
    border: 2px solid rgba(102, 126, 234, 0.1);
}

.feature-box h4 {
    color: #667eea;
    margin-bottom: 10px;
    font-size: 1.2em;
}

/* Skeleton loading animation */
@keyframes skeleton-loading {
    0% { background-position: -200px 0; }
    100% { background-position: calc(200px + 100%) 0; }
}

.skeleton {
    background: linear-gradient(90deg, var(--card-bg) 0px, rgba(102, 126, 234, 0.1) 40px, var(--card-bg) 80px);
    background-size: 200px 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 8px;
}

.skeleton-card {
    background: var(--glass-bg);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.skeleton-text {
    height: 16px;
    margin-bottom: 12px;
}

.skeleton-title {
    height: 24px;
    width: 60%;
    margin-bottom: 16px;
}

.skeleton-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 16px;
}

/* Better mobile responsiveness */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    header {
        padding: 40px 15px;
    }

    header h1 {
        font-size: 2.2em;
    }

    header p {
        font-size: 1.1em;
    }

    .dark-mode-toggle {
        top: 10px;
        right: 10px;
        padding: 10px 16px;
        font-size: 1em;
    }

    .dark-mode-toggle .icon {
        font-size: 1.1em;
    }

    .toast-container {
        top: 60px;
        right: 10px;
        left: 10px;
    }

    .toast {
        min-width: auto;
        width: 100%;
    }

    .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .stat-card {
        padding: 20px 15px;
    }

    .stat-card .number {
        font-size: 2em;
    }

    .main-card {
        padding: 20px 15px;
        border-radius: 15px;
    }

    .tabs {
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    .tabs::-webkit-scrollbar {
        display: none;
    }

    .tab {
        padding: 12px 20px;
        font-size: 14px;
        white-space: nowrap;
        flex-shrink: 0;
    }

    h2 {
        font-size: 1.5em;
    }

    .entity-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .quick-btn {
        padding: 12px 16px;
        font-size: 13px;
    }

    .controls {
        flex-direction: column;
        gap: 10px;
    }

    .controls > * {
        width: 100%;
    }

    button, select, input {
        font-size: 14px;
        padding: 12px 18px;
    }

    .search-hero {
        margin-top: 20px;
    }

    .search-input {
        font-size: 16px;
        padding: 16px 50px 16px 20px;
    }

    .search-btn {
        padding: 10px 20px;
        font-size: 14px;
    }

    #graphContainer {
        height: 400px;
    }

    #keyboardHelpOverlay > div {
        padding: 30px 20px;
        width: 95%;
    }

    #keyboardHelpOverlay h2 {
        font-size: 1.3em;
    }

    .kbd {
        padding: 2px 6px;
        font-size: 0.75em;
    }
}

@media (max-width: 480px) {
    header h1 {
        font-size: 1.8em;
    }

    header p {
        font-size: 1em;
    }

    .stats {
        grid-template-columns: 1fr;
    }

    .stat-card .icon {
        font-size: 2em;
    }

    .stat-card .number {
        font-size: 1.8em;
    }

    .quick-actions {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<!-- Dark Mode Toggle -->
<div class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode (Ctrl+D)">
    <span class="icon" id="darkModeIcon">ğŸŒ™</span>
    <span id="darkModeText">Dark</span>
</div>

<!-- Toast Notifications Container -->
<div class="toast-container" id="toastContainer"></div>

<div class="container">
    <header>
        <div class="header-icon">
            <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                <circle cx="32" cy="16" r="6" fill="white" opacity="0.95"/>
                <circle cx="16" cy="32" r="6" fill="white" opacity="0.95"/>
                <circle cx="48" cy="32" r="6" fill="white" opacity="0.95"/>
                <circle cx="32" cy="48" r="6" fill="white" opacity="0.95"/>
                <line x1="32" y1="16" x2="16" y2="32" stroke="white" stroke-width="3" opacity="0.7"/>
                <line x1="32" y1="16" x2="48" y2="32" stroke="white" stroke-width="3" opacity="0.7"/>
                <line x1="16" y1="32" x2="32" y2="48" stroke="white" stroke-width="3" opacity="0.7"/>
                <line x1="48" y1="32" x2="32" y2="48" stroke="white" stroke-width="3" opacity="0.7"/>
            </svg>
            <h1>BioGraph</h1>
        </div>
        <p>Life Sciences Knowledge Graph â€¢ Obesity â€¢ Alzheimer's â€¢ KRAS Oncology</p>

        <div class="search-hero">
            <input type="text" class="search-input" placeholder="Search drugs, diseases, trials, targets..." id="heroSearch">
            <button class="search-btn" onclick="performSearch()">Search</button>
        </div>
    </header>

    <div class="stats" id="stats">
        <div class="stat-card" onclick="quickLoad('disease', 50)">
            <div class="icon">ğŸ¦ </div>
            <div class="number" id="stat-diseases">-</div>
            <div class="label">Diseases</div>
        </div>
        <div class="stat-card" onclick="quickLoad('drug', 50)">
            <div class="icon">ğŸ’Š</div>
            <div class="number" id="stat-drugs">-</div>
            <div class="label">Drugs</div>
        </div>
        <div class="stat-card" onclick="quickLoad('trial', 50)">
            <div class="icon">ğŸ”¬</div>
            <div class="number" id="stat-trials">-</div>
            <div class="label">Clinical Trials</div>
        </div>
        <div class="stat-card" onclick="quickLoad('publication', 50)">
            <div class="icon">ğŸ“„</div>
            <div class="number" id="stat-publications">-</div>
            <div class="label">Publications</div>
        </div>
        <div class="stat-card" onclick="switchTab('relationships')">
            <div class="icon">ğŸ”—</div>
            <div class="number" id="stat-edges">-</div>
            <div class="label">Relationships</div>
        </div>
    </div>

    <div class="main-card">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('entities')">ğŸ” Explore</button>
            <button class="tab" onclick="switchTab('relationships')">ğŸ”— Relationships</button>
            <button class="tab" onclick="switchTab('graph')">ğŸ“Š Graph</button>
            <button class="tab" onclick="switchTab('analytics')">ğŸ“ˆ Analytics</button>
            <button class="tab" onclick="switchTab('library')">â­ Library</button>
            <button class="tab" onclick="switchTab('chat')">ğŸ’¬ Chat</button>
            <button class="tab" onclick="switchTab('about')">â„¹ï¸ About</button>
        </div>

        <div id="tab-entities" class="tab-content active">
            <h2>Explore the Knowledge Graph</h2>
            <div class="quick-actions">
                <button class="quick-btn" onclick="quickLoad('drug', 30)">ğŸ’Š Drugs</button>
                <button class="quick-btn" onclick="quickLoad('disease', 30)">ğŸ¦  Diseases</button>
                <button class="quick-btn" onclick="quickLoad('target', 30)">ğŸ¯ Targets</button>
                <button class="quick-btn" onclick="quickLoad('trial', 30)">ğŸ”¬ Trials</button>
                <button class="quick-btn" onclick="quickLoad('company', 30)">ğŸ¢ Companies</button>
                <button class="quick-btn" onclick="quickLoad('publication', 30)">ğŸ“„ Publications</button>
                <button class="quick-btn" onclick="quickLoad('patent', 20)">ğŸ“‹ Patents</button>
                <button class="quick-btn" onclick="quickLoad('news', 20)">ğŸ“° News</button>
            </div>
            <div class="controls">
                <select id="kind">
                    <option value="drug">ğŸ’Š Drugs</option>
                    <option value="disease">ğŸ¦  Diseases</option>
                    <option value="target">ğŸ¯ Targets</option>
                    <option value="trial">ğŸ”¬ Clinical Trials</option>
                    <option value="company">ğŸ¢ Companies</option>
                    <option value="publication">ğŸ“„ Publications</option>
                    <option value="patent">ğŸ“‹ Patents</option>
                    <option value="news">ğŸ“° News</option>
                </select>
                <input id="limit" type="number" value="30" min="1" max="100" placeholder="Limit" />
                <button id="loadEntities">Load Results</button>
                <button class="export-btn" onclick="exportData('entities', 'json')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" title="Export as JSON (Ctrl+E)">ğŸ“¥ JSON</button>
                <button class="export-btn" onclick="exportData('entities', 'csv')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" title="Export as CSV">ğŸ“Š CSV</button>
            </div>
            <div class="results-container">
                <div id="entitiesOut"></div>
            </div>
        </div>

        <div id="tab-relationships" class="tab-content">
            <h2>Explore Relationships</h2>
            <div class="quick-actions">
                <button class="quick-btn" onclick="loadEdges('targets')">ğŸ¯ Drug â†’ Target</button>
                <button class="quick-btn" onclick="loadEdges('treats')">ğŸ’Š Drug â†’ Disease</button>
                <button class="quick-btn" onclick="loadEdges('for_condition')">ğŸ”¬ Trial â†’ Disease</button>
                <button class="quick-btn" onclick="loadEdges('develops')">ğŸ¢ Company â†’ Drug</button>
                <button class="quick-btn" onclick="loadEdges('mentions')">ğŸ“„ Publication â†’ Drug</button>
                <button class="quick-btn" onclick="loadEdges('associated_with')">ğŸ¯ Target â†’ Disease</button>
                <button class="quick-btn" onclick="loadEdges('sponsored_by')">ğŸ”¬ Trial â†’ Company</button>
            </div>
            <div class="controls">
                <input id="pred" placeholder="Filter by relationship type (optional)" style="flex: 1;" />
                <input id="edgeLimit" type="number" value="50" min="1" max="200" />
                <button id="loadEdges">Load Relationships</button>
                <button class="export-btn" onclick="exportData('edges', 'json')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ğŸ“¥ JSON</button>
                <button class="export-btn" onclick="exportData('edges', 'csv')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">ğŸ“Š CSV</button>
            </div>
            <div class="results-container">
                <div id="edgesOut"></div>
            </div>
        </div>

        <div id="tab-graph" class="tab-content">
            <h2>Interactive Knowledge Graph</h2>
            <div class="controls">
                <select id="graphEntityType">
                    <option value="drug">ğŸ’Š Drugs</option>
                    <option value="disease">ğŸ¦  Diseases</option>
                    <option value="target">ğŸ¯ Targets</option>
                    <option value="trial">ğŸ”¬ Clinical Trials</option>
                    <option value="company">ğŸ¢ Companies</option>
                </select>
                <input id="graphLimit" type="number" value="20" min="5" max="50" placeholder="Node limit" />
                <button onclick="loadGraphData()">Load Graph</button>
                <button onclick="resetGraphZoom()" style="background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);">Reset View</button>
            </div>
            <div style="margin: 20px 0; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; font-size: 0.9em;">
                <strong>ğŸ’¡ Tip:</strong> Click nodes to see details â€¢ Drag nodes to rearrange â€¢ Scroll to zoom â€¢ Drag background to pan
            </div>
            <div id="graphContainer" style="width: 100%; height: 600px; background: white; border-radius: 15px; border: 2px solid rgba(102, 126, 234, 0.2); position: relative; overflow: hidden;">
                <div id="graphCanvas"></div>
                <div id="graphLoading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #667eea; font-size: 1.2em;">
                    Loading graph...
                </div>
            </div>
            <div id="graphStats" style="margin-top: 15px; padding: 15px; background: rgba(118, 75, 162, 0.1); border-radius: 12px; font-size: 0.9em; text-align: center;">
                Select options and click "Load Graph" to visualize the knowledge network
            </div>
        </div>

        <div id="tab-analytics" class="tab-content">
            <h2>Knowledge Graph Analytics</h2>
            <div style="margin-bottom: 30px;">
                <button onclick="loadAnalytics()" style="font-size: 1em; padding: 14px 32px;">
                    ğŸ“Š Generate Analytics Report
                </button>
                <button onclick="exportAnalytics()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-left: 10px; font-size: 1em; padding: 14px 32px;">
                    ğŸ’¾ Export Report
                </button>
            </div>

            <div id="analyticsLoading" style="display: none;">
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton skeleton-circle"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>
            </div>

            <div id="analyticsContent" style="display: none;">
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="glass" style="padding: 25px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="totalEntities">0</div>
                        <div style="color: var(--text-secondary); margin-top: 8px; font-weight: 600; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px;">Total Entities</div>
                    </div>
                    <div class="glass" style="padding: 25px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: 800; background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="totalRelationships">0</div>
                        <div style="color: var(--text-secondary); margin-top: 8px; font-weight: 600; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px;">Relationships</div>
                    </div>
                    <div class="glass" style="padding: 25px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: 800; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="entityTypes">0</div>
                        <div style="color: var(--text-secondary); margin-top: 8px; font-weight: 600; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px;">Entity Types</div>
                    </div>
                    <div class="glass" style="padding: 25px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: 800; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="avgConnections">0</div>
                        <div style="color: var(--text-secondary); margin-top: 8px; font-weight: 600; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px;">Avg Connections</div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <div class="glass" style="padding: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">Entity Distribution</h3>
                        <canvas id="entityChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="glass" style="padding: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">Relationship Types</h3>
                        <canvas id="relationshipChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div class="glass" style="padding: 30px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">Network Density Over Time</h3>
                    <canvas id="timelineChart" style="max-height: 250px;"></canvas>
                </div>

                <!-- Top Entities -->
                <div class="glass" style="padding: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ğŸ”¥ Most Connected Entities</h3>
                    <div id="topEntitiesList"></div>
                </div>
            </div>

            <div id="analyticsEmpty" style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
                <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.3;">ğŸ“Š</div>
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">Analytics Dashboard</h3>
                <p style="font-size: 1.1em;">Click "Generate Analytics Report" to see comprehensive insights about your knowledge graph.</p>
            </div>
        </div>

        <div id="tab-library" class="tab-content">
            <h2>My Library</h2>
            <div style="margin-bottom: 30px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="showLibrarySection('favorites')" class="quick-btn" style="flex: 1; min-width: 150px;">â­ Favorites (<span id="favoritesCount">0</span>)</button>
                    <button onclick="showLibrarySection('tagged')" class="quick-btn" style="flex: 1; min-width: 150px;">ğŸ·ï¸ Tagged (<span id="taggedCount">0</span>)</button>
                    <button onclick="showLibrarySection('commented')" class="quick-btn" style="flex: 1; min-width: 150px;">ğŸ’¬ Commented (<span id="commentedCount">0</span>)</button>
                    <button onclick="clearLibrary()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 14px 22px;">ğŸ—‘ï¸ Clear All</button>
                </div>
            </div>

            <div id="libraryContent">
                <div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
                    <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.3;">â­</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 15px;">Your Personal Library</h3>
                    <p style="font-size: 1.1em; max-width: 500px; margin: 0 auto;">
                        Save entities, add tags, and write notes as you explore the knowledge graph.
                        Click the â­ on any entity to add it to your favorites!
                    </p>
                </div>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <h2>AI Research Assistant</h2>
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 30px; border-radius: 15px; border: 2px solid rgba(102, 126, 234, 0.2); margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                    <div style="font-size: 3em;">ğŸ¤–</div>
                    <div>
                        <h3 style="color: var(--text-primary); margin-bottom: 8px;">Claude AI Integration</h3>
                        <p style="color: var(--text-secondary); margin: 0;">Ask questions about the knowledge graph, discover insights, and explore connections using natural language.</p>
                    </div>
                </div>
            </div>

            <div id="chatMessages" style="background: var(--glass-bg); border-radius: 15px; padding: 30px; min-height: 400px; max-height: 500px; overflow-y: auto; margin-bottom: 20px; border: 2px solid var(--glass-border);">
                <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                    <div style="font-size: 2.5em; margin-bottom: 15px;">ğŸ’¬</div>
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">Ready to Chat!</h4>
                    <p>Try asking:<br/>
                        â€¢ "What are the most promising KRAS inhibitors?"<br/>
                        â€¢ "Show me all trials for Alzheimer's disease"<br/>
                        â€¢ "Which companies are developing obesity treatments?"
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 15px;">
                <input id="chatInput" type="text" placeholder="Ask about drugs, diseases, trials, targets..." style="flex: 1; font-size: 16px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" style="padding: 14px 32px; font-size: 1em;">
                    <span id="chatButtonText">Send</span>
                </button>
            </div>

            <div style="margin-top: 20px; padding: 20px; background: rgba(251, 146, 60, 0.1); border-radius: 12px; border-left: 4px solid #fb923c;">
                <strong>ğŸš§ Coming Soon:</strong> Connect your Claude API key to enable AI-powered insights, relationship discovery, and semantic search across the knowledge graph.
            </div>
        </div>

        <div id="tab-about" class="tab-content">
            <div class="about-section">
                <h2>About BioGraph</h2>
                <p>
                    BioGraph is a comprehensive life sciences knowledge graph that integrates data from authoritative public sources
                    to connect drugs, diseases, targets, clinical trials, publications, and companies. Built with modern entity resolution
                    and comprehensive MeSH indexing for PubMed-style semantic search.
                </p>

                <div class="feature-grid">
                    <div class="feature-box">
                        <h4>ğŸ¯ Entity Resolution</h4>
                        <p>Automatic deduplication during ingestion using canonical IDs from ChEMBL, MeSH, and CIK.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ·ï¸ MeSH Indexing</h4>
                        <p>Comprehensive MeSH term assignment across all categories for semantic search.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ“Š Confidence Scores</h4>
                        <p>All relationships tracked with confidence scores (0.0-1.0) for data quality.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ”„ Real-time Updates</h4>
                        <p>Discovery-driven architecture with entities emerging from authoritative data sources.</p>
                    </div>
                </div>

                <h3>Disease Areas (POC)</h3>
                <ul>
                    <li><strong>ğŸ’Š Obesity & Metabolic Disorders:</strong> GLP-1 agonists, GIPR agonists, weight loss therapeutics</li>
                    <li><strong>ğŸ§  Alzheimer's Disease:</strong> Anti-amyloid antibodies, cholinesterase inhibitors, cognitive enhancers</li>
                    <li><strong>ğŸ§¬ KRAS Oncology:</strong> KRAS inhibitors, targeted cancer therapies</li>
                </ul>

                <h3>Data Sources</h3>
                <ul>
                    <li><strong>MeSH (2026):</strong> ~30K disease descriptors with hierarchical ontology</li>
                    <li><strong>ChEMBL:</strong> Drug molecules, targets, and mechanisms of action</li>
                    <li><strong>ClinicalTrials.gov:</strong> Clinical studies with entity resolution</li>
                    <li><strong>OpenTargets:</strong> Drug-target-disease associations with evidence scores</li>
                    <li><strong>PubMed:</strong> Scientific publications with official NLM MeSH indexing</li>
                    <li><strong>FDA:</strong> Drug approvals and regulatory information</li>
                    <li><strong>USPTO:</strong> Patent data linked to drugs and companies</li>
                    <li><strong>News Feeds:</strong> FDA, Fierce Pharma, BioPharma Dive with automated MeSH indexing</li>
                </ul>

                <h3>API Access</h3>
                <p style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 15px; border: 2px solid rgba(102, 126, 234, 0.2);">
                    <strong>Interactive API Documentation:</strong> Visit <a href="/docs" style="color: #667eea; font-weight: 600;">/docs</a>
                    for full API documentation with live testing. Access entities, relationships, and search endpoints programmatically.
                </p>

                <h3 style="margin-top: 40px;">ğŸš€ Coming Soon</h3>
                <div class="feature-grid">
                    <div class="feature-box" style="border-color: #fb923c; background: linear-gradient(135deg, rgba(251, 146, 60, 0.08) 0%, rgba(249, 115, 22, 0.08) 100%);">
                        <h4 style="color: #fb923c;">ğŸ¤– AI Auto-Tagging</h4>
                        <p><strong>KEY FEATURE:</strong> Automatically tag news articles and publications using MeSH terms + custom events taxonomy. Filter by regulatory events, clinical milestones, M&A activity, and more.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ” Claude AI Integration</h4>
                        <p>Natural language search with vector embeddings. Ask complex questions and get entity-grounded answers.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ‘¥ Team Workspaces</h4>
                        <p>Shared libraries, collaborative tagging, @mentions, and team annotations.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ”” Smart Alerts</h4>
                        <p>Get notified when entities you follow have new trials, publications, or regulatory updates.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸ“ Collections & Folders</h4>
                        <p>Organize your research with custom folders, nested collections, and bulk operations.</p>
                    </div>
                    <div class="feature-box">
                        <h4>ğŸŒ Public Sharing</h4>
                        <p>Share libraries publicly, embed graphs on your website, and collaborate across organizations.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">BioGraph Knowledge Graph</p>
        <p>
            <a href="/docs">API Documentation</a> â€¢
            <a href="/health">Health Check</a> â€¢
            <a href="https://github.com/anthropics/claude-code">Built with Claude Code</a> â€¢
            <a href="javascript:void(0)" onclick="toggleKeyboardHelp()">âŒ¨ï¸ Keyboard Shortcuts</a>
        </p>
    </div>
</div>

<!-- Keyboard Shortcuts Help Overlay -->
<div id="keyboardHelpOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; backdrop-filter: blur(10px);" onclick="toggleKeyboardHelp()">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--glass-bg); padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
        <h2 style="margin-bottom: 30px; text-align: center; color: var(--text-primary);">âŒ¨ï¸ Keyboard Shortcuts</h2>
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 15px 30px; color: var(--text-primary);">
            <span class="kbd">Ctrl + D</span> <span>Toggle dark/light mode</span>
            <span class="kbd">Ctrl + E</span> <span>Export entities as JSON</span>
            <span class="kbd">Ctrl + F</span> <span>Focus search bar</span>
            <span class="kbd">Ctrl + 1</span> <span>Switch to Entities tab</span>
            <span class="kbd">Ctrl + 2</span> <span>Switch to Relationships tab</span>
            <span class="kbd">Ctrl + 3</span> <span>Switch to Graph View tab</span>
            <span class="kbd">Ctrl + 4</span> <span>Switch to Analytics tab</span>
            <span class="kbd">Ctrl + 5</span> <span>Switch to About tab</span>
            <span class="kbd">Esc</span> <span>Clear search / Close overlays</span>
            <span class="kbd">?</span> <span>Show this help</span>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="toggleKeyboardHelp()" style="padding: 12px 30px; font-size: 1em;">Got it!</button>
        </div>
    </div>
</div>

<script>
let currentView = 'cards'; // or 'json'
let lastLoadedEntities = [];
let lastLoadedEdges = [];

// ===== DARK MODE =====
function toggleDarkMode() {
    const body = document.body;
    const isDark = body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

    // Update toggle button
    const icon = document.getElementById('darkModeIcon');
    const text = document.getElementById('darkModeText');
    if (isDark) {
        icon.textContent = 'â˜€ï¸';
        text.textContent = 'Light';
        showToast('Dark mode enabled', 'success');
    } else {
        icon.textContent = 'ğŸŒ™';
        text.textContent = 'Dark';
        showToast('Light mode enabled', 'success');
    }
}

// Load dark mode preference
window.addEventListener('DOMContentLoaded', () => {
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'enabled') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
        document.getElementById('darkModeText').textContent = 'Light';
    }
});

// ===== TOAST NOTIFICATIONS =====
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {
        success: 'âœ“',
        error: 'âœ—',
        info: 'â„¹',
        warning: 'âš '
    };

    toast.innerHTML = `
        <span class="icon">${icons[type] || icons.info}</span>
        <span>${message}</span>
    `;

    container.appendChild(toast);

    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(400px)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ===== EXPORT FUNCTIONALITY =====
async function exportData(dataType, format) {
    try {
        let data, filename;

        if (dataType === 'entities') {
            if (lastLoadedEntities.length === 0) {
                showToast('No entities to export. Load data first.', 'warning');
                return;
            }
            data = lastLoadedEntities;
            filename = `biograph-entities-${Date.now()}.${format}`;
        } else if (dataType === 'edges') {
            if (lastLoadedEdges.length === 0) {
                showToast('No relationships to export. Load data first.', 'warning');
                return;
            }
            data = lastLoadedEdges;
            filename = `biograph-relationships-${Date.now()}.${format}`;
        }

        let content, mimeType;

        if (format === 'json') {
            content = JSON.stringify(data, null, 2);
            mimeType = 'application/json';
        } else if (format === 'csv') {
            content = convertToCSV(data);
            mimeType = 'text/csv';
        }

        // Create download
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        showToast(`Exported ${data.length} records as ${format.toUpperCase()}`, 'success');
    } catch (e) {
        showToast(`Export failed: ${e.message}`, 'error');
    }
}

function convertToCSV(data) {
    if (data.length === 0) return '';

    // Get headers from first object
    const headers = Object.keys(data[0]);
    const csvRows = [];

    // Add header row
    csvRows.push(headers.join(','));

    // Add data rows
    for (const row of data) {
        const values = headers.map(header => {
            const value = row[header];
            // Handle commas and quotes in values
            const escaped = String(value).replace(/"/g, '""');
            return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
    }

    return csvRows.join('\n');
}

// ===== KEYBOARD SHORTCUTS =====
function toggleKeyboardHelp() {
    const overlay = document.getElementById('keyboardHelpOverlay');
    if (overlay.style.display === 'none') {
        overlay.style.display = 'block';
        overlay.style.animation = 'fadeIn 0.3s ease';
    } else {
        overlay.style.display = 'none';
    }
}

document.addEventListener('keydown', (e) => {
    // Don't trigger shortcuts if typing in an input field
    const isInputField = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT';

    // ? : Show keyboard shortcuts help
    if (e.key === '?' && !isInputField) {
        e.preventDefault();
        toggleKeyboardHelp();
        return;
    }

    // Escape: Clear search or close overlays
    if (e.key === 'Escape') {
        const helpOverlay = document.getElementById('keyboardHelpOverlay');
        if (helpOverlay.style.display !== 'none') {
            toggleKeyboardHelp();
        } else {
            document.getElementById('heroSearch').value = '';
        }
        return;
    }

    // Don't trigger Ctrl shortcuts if typing in input
    if (isInputField && e.key !== 'Enter') return;

    // Ctrl+D: Toggle dark mode
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        toggleDarkMode();
    }

    // Ctrl+E: Export entities as JSON
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportData('entities', 'json');
    }

    // Ctrl+F: Focus search
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('heroSearch').focus();
    }

    // Ctrl+1-5: Switch tabs
    if (e.ctrlKey && e.key >= '1' && e.key <= '5') {
        e.preventDefault();
        const tabs = ['entities', 'relationships', 'graph', 'analytics', 'about'];
        switchTab(tabs[parseInt(e.key) - 1]);
    }
});

// Show keyboard shortcut hint on first load
window.addEventListener('load', () => {
    const hasSeenHint = localStorage.getItem('keyboardHintSeen');
    if (!hasSeenHint) {
        setTimeout(() => {
            showToast('ğŸ’¡ Tip: Press Ctrl+D for dark mode, Ctrl+E to export', 'info');
            localStorage.setItem('keyboardHintSeen', 'true');
        }, 2000);
    }
});

async function getJSON(path) {
    const r = await fetch(path);
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
}

async function loadStats() {
    try {
        const kinds = ['disease', 'drug', 'trial', 'publication'];
        const promises = kinds.map(k =>
            fetch(`/entities?kind=${k}&limit=1`)
                .then(r => r.json())
                .then(data => data.count || 0)
                .catch(() => 0)
        );

        const edgesPromise = fetch('/edges?limit=1')
            .then(r => r.json())
            .then(data => data.count || 0)
            .catch(() => 0);

        const [diseases, drugs, trials, publications, edges] = await Promise.all([...promises, edgesPromise]);

        document.getElementById('stat-diseases').textContent = diseases.toLocaleString();
        document.getElementById('stat-drugs').textContent = drugs.toLocaleString();
        document.getElementById('stat-trials').textContent = trials.toLocaleString();
        document.getElementById('stat-publications').textContent = publications.toLocaleString();
        document.getElementById('stat-edges').textContent = edges.toLocaleString();
    } catch (e) {
        console.error('Failed to load stats:', e);
    }
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    // Find and activate the clicked tab
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => {
        if (t.onclick && t.onclick.toString().includes(`'${tab}'`)) {
            t.classList.add('active');
        }
    });

    document.getElementById('tab-' + tab).classList.add('active');
}

async function quickLoad(kind, limit) {
    document.getElementById('kind').value = kind;
    document.getElementById('limit').value = limit;
    switchTab('entities');
    await loadEntitiesHandler();
}

function renderEntityCards(items) {
    if (!items || items.length === 0) {
        return '<p style="text-align: center; color: #999; padding: 40px;">No results found</p>';
    }

    return '<div class="entity-grid">' + items.map(item => `
        <div class="entity-card" onclick="showEntityDetail(${item.id}, '${escapeJs(item.name)}', '${item.kind}')" style="cursor: pointer;">
            <div class="entity-name">${escapeHtml(item.name || 'Unnamed')}</div>
            <div class="entity-id">${escapeHtml(item.canonical_id || item.id)}</div>
            <span class="entity-kind kind-${item.kind}">${item.kind}</span>
        </div>
    `).join('') + '</div>';
}

function renderEdgeCards(items) {
    if (!items || items.length === 0) {
        return '<p style="text-align: center; color: #999; padding: 40px;">No relationships found</p>';
    }

    return items.map(item => `
        <div class="edge-card">
            <div>
                <span class="entity-label" onclick="showEntityDetail(${item.src_id}, '${escapeJs(item.src_name)}', '${item.src_kind}')" style="cursor: pointer; text-decoration: underline; text-decoration-color: rgba(102, 126, 234, 0.3); text-underline-offset: 3px;">
                    ${escapeHtml(item.src_name)}
                </span>
                <span style="color: #999; font-size: 0.9em;"> (${item.src_kind})</span>
            </div>
            <div class="edge-predicate">${escapeHtml(item.predicate)}</div>
            <div>
                <span class="entity-label" onclick="showEntityDetail(${item.dst_id}, '${escapeJs(item.dst_name)}', '${item.dst_kind}')" style="cursor: pointer; text-decoration: underline; text-decoration-color: rgba(118, 75, 162, 0.3); text-underline-offset: 3px;">
                    ${escapeHtml(item.dst_name)}
                </span>
                <span style="color: #999; font-size: 0.9em;"> (${item.dst_kind})</span>
            </div>
            <div style="margin-top: 10px; font-size: 0.85em; color: #999;">
                Source: ${item.source} ${item.confidence ? `â€¢ Confidence: ${(item.confidence * 100).toFixed(0)}%` : ''}
            </div>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeJs(text) {
    if (!text) return '';
    return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
}

async function loadEntitiesHandler() {
    const kind = document.getElementById('kind').value;
    const limit = document.getElementById('limit').value;
    const out = document.getElementById('entitiesOut');

    out.innerHTML = '<div class="loading">Loading entities</div>';

    try {
        const data = await getJSON(`/entities?kind=${encodeURIComponent(kind)}&limit=${encodeURIComponent(limit)}`);
        lastLoadedEntities = data.items;
        out.innerHTML = renderEntityCards(data.items);
        showToast(`Loaded ${data.items.length} ${kind} entities`, 'success');
    } catch (e) {
        out.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">Error: ${escapeHtml(String(e))}</div>`;
        showToast('Failed to load entities', 'error');
    }
}

async function loadEdges(predicate) {
    document.getElementById('pred').value = predicate || '';
    await loadEdgesHandler();
}

async function loadEdgesHandler() {
    const pred = document.getElementById('pred').value.trim();
    const limit = document.getElementById('edgeLimit').value;
    const out = document.getElementById('edgesOut');

    out.innerHTML = '<div class="loading">Loading relationships</div>';

    try {
        const qs = new URLSearchParams();
        if (pred) qs.set('predicate', pred);
        qs.set('limit', limit);
        const data = await getJSON(`/edges?${qs.toString()}`);
        lastLoadedEdges = data.items;
        out.innerHTML = renderEdgeCards(data.items);
        showToast(`Loaded ${data.items.length} relationships`, 'success');
    } catch (e) {
        out.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">Error: ${escapeHtml(String(e))}</div>`;
        showToast('Failed to load relationships', 'error');
    }
}

async function performSearch() {
    const query = document.getElementById('heroSearch').value.trim().toLowerCase();
    if (!query) return;

    // Switch to entities tab and show loading
    switchTab('entities');
    const out = document.getElementById('entitiesOut');
    out.innerHTML = '<div class="loading">Searching across all entity types</div>';

    try {
        // Search across all entity types
        const entityTypes = ['drug', 'disease', 'target', 'trial', 'company', 'publication', 'patent', 'news'];
        const promises = entityTypes.map(kind =>
            fetch(`/entities?kind=${kind}&limit=100`)
                .then(r => r.json())
                .then(data => data.items || [])
                .catch(() => [])
        );

        const results = await Promise.all(promises);
        const allEntities = results.flat();

        // Fuzzy search: match query against name or canonical_id
        const matches = allEntities.filter(entity => {
            const name = (entity.name || '').toLowerCase();
            const id = (entity.canonical_id || '').toLowerCase();
            return name.includes(query) || id.includes(query);
        });

        if (matches.length === 0) {
            out.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ”</div>
                    <h3 style="color: #667eea; margin-bottom: 10px;">No results found for "${escapeHtml(query)}"</h3>
                    <p style="color: #999;">Try searching for drugs like "semaglutide", diseases like "obesity", or browse by category below.</p>
                </div>
            `;
        } else {
            // Sort by relevance (exact matches first, then contains)
            matches.sort((a, b) => {
                const aName = (a.name || '').toLowerCase();
                const bName = (b.name || '').toLowerCase();
                const aExact = aName === query ? 0 : 1;
                const bExact = bName === query ? 0 : 1;
                if (aExact !== bExact) return aExact - bExact;
                return aName.localeCompare(bName);
            });

            out.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                    <strong>Found ${matches.length} result${matches.length !== 1 ? 's' : ''}</strong> for "<em>${escapeHtml(query)}</em>"
                </div>
                ${renderEntityCards(matches)}
            `;
        }
    } catch (e) {
        out.innerHTML = `<div style="color: #d32f2f; padding: 20px; text-align: center;">Search error: ${escapeHtml(String(e))}</div>`;
    }
}

async function showEntityDetail(entityId, entityName, entityKind) {
    const out = document.getElementById('entitiesOut');

    out.innerHTML = '<div class="loading">Loading entity details and relationships</div>';

    try {
        // Fetch full entity details
        const entityPromise = fetch(`/entity/${entityId}`).then(r => r.json());

        // Fetch relationships where this entity is the source
        const outgoingPromise = fetch(`/edges?src_id=${entityId}&limit=200`)
            .then(r => r.json())
            .catch(() => ({items: []}));

        // Fetch relationships where this entity is the destination
        const incomingPromise = fetch(`/edges?dst_id=${entityId}&limit=200`)
            .then(r => r.json())
            .catch(() => ({items: []}));

        const [entityData, outgoing, incoming] = await Promise.all([entityPromise, outgoingPromise, incomingPromise]);

        const outgoingEdges = outgoing.items || [];
        const incomingEdges = incoming.items || [];

        // Render detail view
        const isFavorite = !!favorites[entityId];
        let html = `
            <div style="margin-bottom: 30px;">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="loadEntitiesHandler()" style="background: #f0f0f0; color: #667eea; border: 2px solid #667eea;">
                        â† Back to List
                    </button>
                    <button onclick="toggleFavorite(${entityId}, '${escapeJs(entityData.name)}', '${entityData.kind}')" style="background: ${isFavorite ? 'linear-gradient(135deg, #fb923c 0%, #f97316 100%)' : '#f0f0f0'}; color: ${isFavorite ? 'white' : 'var(--text-primary)'};" data-entity-id="${entityId}">
                        ${isFavorite ? 'â­' : 'â˜†'} ${isFavorite ? 'Favorited' : 'Add to Favorites'}
                    </button>
                    <button onclick="promptTag(${entityId})" style="background: #f0f0f0; color: var(--text-primary);">
                        ğŸ·ï¸ Add Tag
                    </button>
                    <button onclick="promptComment(${entityId})" style="background: #f0f0f0; color: var(--text-primary);">
                        ğŸ’¬ Add Note
                    </button>
                </div>

                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 30px; border-radius: 20px; border: 2px solid rgba(102, 126, 234, 0.2); margin-bottom: 30px; position: relative;">
                    <h2 style="margin: 0 0 15px 0; font-size: 2.5em;">${escapeHtml(entityData.name)}</h2>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <span class="entity-kind kind-${entityData.kind}" style="font-size: 1em; padding: 8px 16px;">${entityData.kind}</span>
                        <span style="color: #667eea; font-weight: 600;">ID: ${entityData.id}</span>
                        <span style="color: #764ba2; font-weight: 600;">${entityData.total_relationships} Relationship${entityData.total_relationships !== 1 ? 's' : ''}</span>
                    </div>
                    <div style="font-family: monospace; font-size: 0.9em; color: #666; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px;">
                        ${escapeHtml(entityData.canonical_id)}
                    </div>
                    ${(entityTags[entityId] || []).length > 0 ? `
                        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 6px;">
                            ${(entityTags[entityId] || []).map(tag => `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85em;">ğŸ·ï¸ ${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>

                ${(entityComments[entityId] || []).length > 0 ? `
                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <h4 style="margin: 0 0 12px 0; color: #667eea;">ğŸ’¬ Your Notes (${entityComments[entityId].length})</h4>
                        ${entityComments[entityId].map(c => `
                            <div style="background: rgba(102, 126, 234, 0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="color: var(--text-primary);">${escapeHtml(c.text)}</div>
                                <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 6px;">
                                    ${new Date(c.timestamp).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${renderEntityMetadata(entityData)}
        `;

        if (outgoingEdges.length > 0) {
            html += `
                <h3 style="color: #667eea; margin: 30px 0 15px 0; font-size: 1.5em;">
                    Outgoing Relationships (${outgoingEdges.length})
                </h3>
                ${renderEdgeCards(outgoingEdges)}
            `;
        }

        if (incomingEdges.length > 0) {
            html += `
                <h3 style="color: #764ba2; margin: 30px 0 15px 0; font-size: 1.5em;">
                    Incoming Relationships (${incomingEdges.length})
                </h3>
                ${renderEdgeCards(incomingEdges)}
            `;
        }

        if (entityData.total_relationships === 0) {
            html += '<p style="text-align: center; color: #999; padding: 60px 20px; font-size: 1.2em;">No relationships found for this entity</p>';
        }

        html += '</div>';

        out.innerHTML = html;

        // Scroll to top of results
        out.scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch (e) {
        out.innerHTML = `
            <button onclick="loadEntitiesHandler()" style="margin-bottom: 20px;">â† Back to List</button>
            <div style="color: #d32f2f; padding: 20px; text-align: center;">Error loading entity details: ${escapeHtml(String(e))}</div>
        `;
    }
}

function renderEntityMetadata(entity) {
    let html = '';

    // Aliases
    if (entity.aliases && entity.aliases.length > 0) {
        html += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <h4 style="margin: 0 0 12px 0; color: #667eea;">Alternative Names (${entity.aliases.length})</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${entity.aliases.map(a => `
                        <span style="background: #f0f0f0; padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">
                            ${escapeHtml(a.alias)}
                            <span style="color: #999; font-size: 0.85em;">Â·${a.source}</span>
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Trial details
    if (entity.trial_details) {
        const t = entity.trial_details;
        html += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #7b1fa2;">
                <h4 style="margin: 0 0 12px 0; color: #7b1fa2;">Clinical Trial Details</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${t.nct_id ? `<div><strong>NCT ID:</strong> ${escapeHtml(t.nct_id)}</div>` : ''}
                    ${t.phase ? `<div><strong>Phase:</strong> ${escapeHtml(t.phase)}</div>` : ''}
                    ${t.status ? `<div><strong>Status:</strong> ${escapeHtml(t.status)}</div>` : ''}
                    ${t.enrollment ? `<div><strong>Enrollment:</strong> ${t.enrollment}</div>` : ''}
                    ${t.start_date ? `<div><strong>Start:</strong> ${t.start_date}</div>` : ''}
                    ${t.completion_date ? `<div><strong>Completion:</strong> ${t.completion_date}</div>` : ''}
                </div>
                ${t.brief_title ? `<p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">${escapeHtml(t.brief_title)}</p>` : ''}
            </div>
        `;
    }

    // News details
    if (entity.news_details) {
        const n = entity.news_details;
        html += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #00796b;">
                <h4 style="margin: 0 0 12px 0; color: #00796b;">News Article</h4>
                ${n.published_date ? `<div style="color: #666; font-size: 0.9em; margin-bottom: 10px;">ğŸ“… ${new Date(n.published_date).toLocaleDateString()}</div>` : ''}
                ${n.summary ? `<p style="margin-bottom: 15px;">${escapeHtml(n.summary)}</p>` : ''}
                ${n.url ? `<a href="${escapeHtml(n.url)}" target="_blank" style="color: #667eea; font-weight: 600;">Read Full Article â†’</a>` : ''}
                ${n.source ? `<div style="margin-top: 10px; color: #999; font-size: 0.85em;">Source: ${escapeHtml(n.source)}</div>` : ''}
            </div>
        `;
    }

    // MeSH trees for diseases
    if (entity.mesh_trees && entity.mesh_trees.length > 0) {
        html += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #d32f2f;">
                <h4 style="margin: 0 0 12px 0; color: #d32f2f;">MeSH Hierarchy</h4>
                <div style="font-family: monospace; font-size: 0.9em; line-height: 1.8;">
                    ${entity.mesh_trees.map(tree => `<div>${escapeHtml(tree)}</div>`).join('')}
                </div>
            </div>
        `;
    }

    // MeSH terms (for news or publications)
    if (entity.mesh_terms && entity.mesh_terms.length > 0) {
        html += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #1976d2;">
                <h4 style="margin: 0 0 12px 0; color: #1976d2;">MeSH Indexing (${entity.mesh_terms.length} terms)</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${entity.mesh_terms.slice(0, 20).map(m => `
                        <span style="background: ${m.is_major_topic ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f0f0f0'};
                                     color: ${m.is_major_topic ? 'white' : '#333'};
                                     padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">
                            ${escapeHtml(m.mesh_name)}
                            ${m.is_major_topic ? ' â­' : ''}
                        </span>
                    `).join('')}
                    ${entity.mesh_terms.length > 20 ? `<span style="color: #999; padding: 6px;">+${entity.mesh_terms.length - 20} more</span>` : ''}
                </div>
            </div>
        `;
    }

    // Publication types
    if (entity.publication_types && entity.publication_types.length > 0) {
        html += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #c2185b;">
                <h4 style="margin: 0 0 12px 0; color: #c2185b;">Publication Types</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${entity.publication_types.map(pt => `
                        <span style="background: #fce4ec; color: #c2185b; padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">
                            ${escapeHtml(pt)}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    return html;
}

// ===== LIBRARY & COLLABORATION =====
let favorites = JSON.parse(localStorage.getItem('biograph_favorites') || '{}');
let entityTags = JSON.parse(localStorage.getItem('biograph_tags') || '{}');
let entityComments = JSON.parse(localStorage.getItem('biograph_comments') || '{}');

function toggleFavorite(entityId, entityName, entityKind) {
    if (favorites[entityId]) {
        delete favorites[entityId];
        showToast(`Removed from favorites`, 'info');
    } else {
        favorites[entityId] = { id: entityId, name: entityName, kind: entityKind, addedAt: new Date().toISOString() };
        showToast(`â­ Added to favorites`, 'success');
    }
    localStorage.setItem('biograph_favorites', JSON.stringify(favorites));
    updateLibraryCounts();
    updateFavoriteButtons();
}

function addTag(entityId, tag) {
    if (!entityTags[entityId]) entityTags[entityId] = [];
    if (!entityTags[entityId].includes(tag)) {
        entityTags[entityId].push(tag);
        localStorage.setItem('biograph_tags', JSON.stringify(entityTags));
        showToast(`Tagged with "${tag}"`, 'success');
        updateLibraryCounts();
    }
}

function addComment(entityId, comment) {
    if (!entityComments[entityId]) entityComments[entityId] = [];
    entityComments[entityId].push({
        text: comment,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('biograph_comments', JSON.stringify(entityComments));
    showToast('Comment added', 'success');
    updateLibraryCounts();
}

function updateLibraryCounts() {
    document.getElementById('favoritesCount').textContent = Object.keys(favorites).length;
    document.getElementById('taggedCount').textContent = Object.keys(entityTags).length;
    document.getElementById('commentedCount').textContent = Object.keys(entityComments).length;
}

function updateFavoriteButtons() {
    // Update favorite button state on entity cards if visible
    document.querySelectorAll('[data-entity-id]').forEach(btn => {
        const id = btn.dataset.entityId;
        btn.textContent = favorites[id] ? 'â­' : 'â˜†';
        btn.style.color = favorites[id] ? '#fb923c' : 'var(--text-secondary)';
    });
}

function showLibrarySection(section) {
    const content = document.getElementById('libraryContent');

    if (section === 'favorites') {
        const items = Object.values(favorites);
        if (items.length === 0) {
            content.innerHTML = `<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 3em; margin-bottom: 15px;">â­</div>
                <p>No favorites yet. Click the â­ on any entity to save it!</p>
            </div>`;
            return;
        }

        content.innerHTML = '<div class="entity-grid">' + items.map(item => `
            <div class="entity-card" onclick="showEntityDetail(${item.id}, '${escapeJs(item.name)}', '${item.kind}')" style="cursor: pointer; position: relative;">
                <button onclick="event.stopPropagation(); toggleFavorite(${item.id}, '${escapeJs(item.name)}', '${item.kind}')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 5px;">â­</button>
                <div class="entity-name">${escapeHtml(item.name)}</div>
                <span class="entity-kind kind-${item.kind}">${item.kind}</span>
                <div style="margin-top: 10px; font-size: 0.85em; color: var(--text-secondary);">
                    Added ${new Date(item.addedAt).toLocaleDateString()}
                </div>
            </div>
        `).join('') + '</div>';
    }

    else if (section === 'tagged') {
        if (Object.keys(entityTags).length === 0) {
            content.innerHTML = `<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ·ï¸</div>
                <p>No tagged entities yet.</p>
            </div>`;
            return;
        }

        content.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">' +
            Object.entries(entityTags).map(([id, tags]) => `
                <div style="background: var(--glass-bg); padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border);">
                    <div style="font-weight: 600; margin-bottom: 8px;">Entity #${id}</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${tags.map(tag => `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85em;">${escapeHtml(tag)}</span>`).join('')}
                    </div>
                </div>
            `).join('') + '</div>';
    }

    else if (section === 'commented') {
        if (Object.keys(entityComments).length === 0) {
            content.innerHTML = `<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ’¬</div>
                <p>No comments yet.</p>
            </div>`;
            return;
        }

        content.innerHTML = Object.entries(entityComments).map(([id, comments]) => `
            <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">Entity #${id}</div>
                ${comments.map(c => `
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="color: var(--text-primary);">${escapeHtml(c.text)}</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 6px;">
                            ${new Date(c.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).join('')}
            </div>
        `).join('');
    }
}

function clearLibrary() {
    if (!confirm('Clear all favorites, tags, and comments? This cannot be undone.')) return;

    favorites = {};
    entityTags = {};
    entityComments = {};

    localStorage.removeItem('biograph_favorites');
    localStorage.removeItem('biograph_tags');
    localStorage.removeItem('biograph_comments');

    updateLibraryCounts();
    showToast('Library cleared', 'success');

    const content = document.getElementById('libraryContent');
    content.innerHTML = `<div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
        <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.3;">â­</div>
        <h3 style="color: var(--text-primary); margin-bottom: 15px;">Library Cleared</h3>
        <p style="font-size: 1.1em;">Start exploring and save your favorite entities!</p>
    </div>`;
}

function promptTag(entityId) {
    const tag = prompt('Enter a tag for this entity:');
    if (tag && tag.trim()) {
        addTag(entityId, tag.trim());
        // Reload the entity detail to show the new tag
        const entity = document.querySelector(`[data-entity-id="${entityId}"]`);
        if (entity) {
            location.reload(); // Simple reload to show tags
        }
    }
}

function promptComment(entityId) {
    const comment = prompt('Add a note about this entity:');
    if (comment && comment.trim()) {
        addComment(entityId, comment.trim());
        location.reload(); // Simple reload to show comment
    }
}

// ===== CHAT INTERFACE =====
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    const messagesDiv = document.getElementById('chatMessages');
    const buttonText = document.getElementById('chatButtonText');

    // Add user message
    messagesDiv.innerHTML += `
        <div style="margin-bottom: 20px; text-align: right;">
            <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 18px; border-radius: 18px 18px 4px 18px; max-width: 70%;">
                ${escapeHtml(message)}
            </div>
        </div>
    `;

    input.value = '';
    buttonText.textContent = '...';

    // Simulate AI response
    setTimeout(() => {
        messagesDiv.innerHTML += `
            <div style="margin-bottom: 20px;">
                <div style="display: inline-block; background: var(--glass-bg); border: 2px solid var(--glass-border); padding: 12px 18px; border-radius: 18px 18px 18px 4px; max-width: 70%;">
                    <div style="color: var(--text-primary); margin-bottom: 8px;">
                        ğŸ¤– <strong>Claude:</strong> Great question! To enable AI-powered responses, you'll need to connect your Claude API key in settings.
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                        Coming soon: Real-time semantic search, entity recommendations, and insights based on your query.
                    </div>
                </div>
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        buttonText.textContent = 'Send';
        showToast('ğŸ’¡ Claude API integration coming soon!', 'info');
    }, 1000);

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// ===== ANALYTICS DASHBOARD =====
let analyticsData = null;
let entityChartInstance = null;
let relationshipChartInstance = null;
let timelineChartInstance = null;

async function loadAnalytics() {
    const loading = document.getElementById('analyticsLoading');
    const content = document.getElementById('analyticsContent');
    const empty = document.getElementById('analyticsEmpty');

    loading.style.display = 'block';
    content.style.display = 'none';
    empty.style.display = 'none';

    try {
        // Fetch all entity types
        const entityTypes = ['drug', 'disease', 'target', 'trial', 'company', 'publication', 'patent', 'news'];
        const promises = entityTypes.map(kind =>
            fetch(`/entities?kind=${kind}&limit=200`)
                .then(r => r.json())
                .then(data => ({ kind, count: data.count || data.items?.length || 0, items: data.items || [] }))
                .catch(() => ({ kind, count: 0, items: [] }))
        );

        const edgesPromise = fetch('/edges?limit=500')
            .then(r => r.json())
            .then(data => ({ items: data.items || [], count: data.count || data.items?.length || 0 }))
            .catch(() => ({ items: [], count: 0 }));

        const [entitiesData, edgesData] = await Promise.all([Promise.all(promises), edgesPromise]);

        // Calculate metrics
        const totalEntities = entitiesData.reduce((sum, e) => sum + e.count, 0);
        const totalRelationships = edgesData.count;
        const activeEntityTypes = entitiesData.filter(e => e.count > 0).length;
        const avgConnections = totalEntities > 0 ? (totalRelationships * 2 / totalEntities).toFixed(1) : 0;

        // Update key metrics
        document.getElementById('totalEntities').textContent = totalEntities.toLocaleString();
        document.getElementById('totalRelationships').textContent = totalRelationships.toLocaleString();
        document.getElementById('entityTypes').textContent = activeEntityTypes;
        document.getElementById('avgConnections').textContent = avgConnections;

        // Store data
        analyticsData = { entitiesData, edgesData, totalEntities, totalRelationships };

        // Create charts
        createEntityChart(entitiesData);
        createRelationshipChart(edgesData.items);
        createTimelineChart();
        createTopEntitiesList(entitiesData, edgesData.items);

        loading.style.display = 'none';
        content.style.display = 'block';

        showToast('Analytics generated successfully', 'success');
    } catch (e) {
        loading.style.display = 'none';
        empty.style.display = 'block';
        showToast('Failed to generate analytics', 'error');
        console.error('Analytics error:', e);
    }
}

function createEntityChart(entitiesData) {
    const ctx = document.getElementById('entityChart');
    if (!ctx) return;

    // Destroy existing chart
    if (entityChartInstance) {
        entityChartInstance.destroy();
    }

    const labels = entitiesData.filter(e => e.count > 0).map(e => e.kind);
    const data = entitiesData.filter(e => e.count > 0).map(e => e.count);
    const colors = {
        drug: '#1976d2',
        disease: '#d32f2f',
        target: '#f57c00',
        trial: '#7b1fa2',
        company: '#00796b',
        publication: '#c2185b',
        patent: '#455a64',
        news: '#0097a7'
    };

    entityChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
            datasets: [{
                data: data,
                backgroundColor: labels.map(l => colors[l] || '#999'),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12, weight: '600' }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createRelationshipChart(edges) {
    const ctx = document.getElementById('relationshipChart');
    if (!ctx) return;

    if (relationshipChartInstance) {
        relationshipChartInstance.destroy();
    }

    // Count relationship types
    const predicateCounts = {};
    edges.forEach(edge => {
        const pred = edge.predicate || 'unknown';
        predicateCounts[pred] = (predicateCounts[pred] || 0) + 1;
    });

    const sortedPredicates = Object.entries(predicateCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

    const labels = sortedPredicates.map(([pred]) => pred);
    const data = sortedPredicates.map(([, count]) => count);

    relationshipChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Count',
                data: data,
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: '#667eea',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y} relationships`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { font: { size: 11 } }
                },
                x: {
                    ticks: {
                        font: { size: 10 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

function createTimelineChart() {
    const ctx = document.getElementById('timelineChart');
    if (!ctx) return;

    if (timelineChartInstance) {
        timelineChartInstance.destroy();
    }

    // Simulated timeline data (in real app, would use actual timestamps)
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const entities = months.map((_, i) => Math.floor(Math.random() * 100) + 50 + i * 10);
    const relationships = months.map((_, i) => Math.floor(Math.random() * 150) + 100 + i * 15);

    timelineChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Entities Added',
                    data: entities,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                },
                {
                    label: 'Relationships Added',
                    data: relationships,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: { size: 12, weight: '600' }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { font: { size: 11 } }
                },
                x: {
                    ticks: { font: { size: 11 } }
                }
            }
        }
    });
}

function createTopEntitiesList(entitiesData, edges) {
    const list = document.getElementById('topEntitiesList');
    if (!list) return;

    // Calculate connection counts
    const connectionCounts = {};
    edges.forEach(edge => {
        connectionCounts[edge.src_id] = (connectionCounts[edge.src_id] || 0) + 1;
        connectionCounts[edge.dst_id] = (connectionCounts[edge.dst_id] || 0) + 1;
    });

    // Get all entities with connections
    const allEntities = entitiesData.flatMap(e => e.items);
    const entitiesWithConnections = allEntities
        .map(entity => ({
            ...entity,
            connections: connectionCounts[entity.id] || 0
        }))
        .filter(e => e.connections > 0)
        .sort((a, b) => b.connections - a.connections)
        .slice(0, 10);

    const kindColors = {
        drug: '#1976d2',
        disease: '#d32f2f',
        target: '#f57c00',
        trial: '#7b1fa2',
        company: '#00796b',
        publication: '#c2185b',
        patent: '#455a64',
        news: '#0097a7'
    };

    list.innerHTML = entitiesWithConnections.map((entity, index) => `
        <div style="display: flex; align-items: center; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 12px; margin-bottom: 12px; border-left: 4px solid ${kindColors[entity.kind] || '#999'}; cursor: pointer; transition: all 0.3s;" onclick="showEntityDetail(${entity.id}, '${escapeJs(entity.name)}', '${entity.kind}'); switchTab('entities');" onmouseover="this.style.transform='translateX(5px)'; this.style.background='rgba(102, 126, 234, 0.1)';" onmouseout="this.style.transform='translateX(0)'; this.style.background='rgba(102, 126, 234, 0.05)';">
            <div style="font-size: 1.5em; font-weight: 800; color: ${kindColors[entity.kind] || '#999'}; width: 40px; text-align: center;">#${index + 1}</div>
            <div style="flex: 1; margin-left: 15px;">
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${escapeHtml(entity.name)}</div>
                <div style="font-size: 0.85em; color: var(--text-secondary);">
                    <span class="entity-kind kind-${entity.kind}" style="margin-right: 8px;">${entity.kind}</span>
                    <span>${entity.connections} connections</span>
                </div>
            </div>
            <div style="font-size: 1.2em; color: ${kindColors[entity.kind] || '#999'};">â†’</div>
        </div>
    `).join('');
}

async function exportAnalytics() {
    if (!analyticsData) {
        showToast('Generate analytics first', 'warning');
        return;
    }

    const report = {
        generated: new Date().toISOString(),
        summary: {
            totalEntities: analyticsData.totalEntities,
            totalRelationships: analyticsData.totalRelationships,
            entityTypes: analyticsData.entitiesData.filter(e => e.count > 0).length,
            avgConnections: (analyticsData.totalRelationships * 2 / analyticsData.totalEntities).toFixed(2)
        },
        entityDistribution: analyticsData.entitiesData.map(e => ({ kind: e.kind, count: e.count })),
        relationshipTypes: {}
    };

    // Count relationship types
    analyticsData.edgesData.items.forEach(edge => {
        const pred = edge.predicate || 'unknown';
        report.relationshipTypes[pred] = (report.relationshipTypes[pred] || 0) + 1;
    });

    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `biograph-analytics-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('Analytics report exported', 'success');
}

// ===== GRAPH VISUALIZATION =====
let graphSimulation = null;
let graphSvg = null;
let graphG = null;
let graphZoom = null;

async function loadGraphData() {
    const kind = document.getElementById('graphEntityType').value;
    const limit = parseInt(document.getElementById('graphLimit').value);
    const loading = document.getElementById('graphLoading');
    const stats = document.getElementById('graphStats');

    loading.style.display = 'block';
    stats.textContent = 'Loading data...';

    try {
        // Fetch entities and their relationships
        const entitiesData = await fetch(`/entities?kind=${kind}&limit=${limit}`).then(r => r.json());
        const entities = entitiesData.items || [];

        if (entities.length === 0) {
            loading.style.display = 'none';
            stats.innerHTML = '<span style="color: #d32f2f;">No entities found. Try loading data first or select a different type.</span>';
            return;
        }

        // Fetch edges for these entities
        const entityIds = entities.map(e => e.id);
        const edgePromises = entityIds.map(id =>
            fetch(`/edges?src_id=${id}&limit=100`).then(r => r.json()).then(d => d.items || []).catch(() => [])
        );
        const edgeResults = await Promise.all(edgePromises);
        const edges = edgeResults.flat();

        // Build node map (include connected entities)
        const nodeMap = new Map();
        entities.forEach(e => {
            nodeMap.set(e.id, { id: e.id, name: e.name, kind: e.kind, canonical_id: e.canonical_id });
        });

        // Add destination entities from edges
        edges.forEach(e => {
            if (!nodeMap.has(e.dst_id)) {
                nodeMap.set(e.dst_id, { id: e.dst_id, name: e.dst_name, kind: e.dst_kind, canonical_id: `${e.dst_kind}:${e.dst_id}` });
            }
        });

        const nodes = Array.from(nodeMap.values());
        const links = edges.map(e => ({
            source: e.src_id,
            target: e.dst_id,
            predicate: e.predicate,
            confidence: e.confidence || 1.0
        }));

        loading.style.display = 'none';
        stats.innerHTML = `<strong>ğŸ“Š Graph:</strong> ${nodes.length} nodes, ${links.length} relationships`;

        renderGraph(nodes, links);
    } catch (e) {
        loading.style.display = 'none';
        stats.innerHTML = `<span style="color: #d32f2f;">Error loading graph: ${escapeHtml(String(e))}</span>`;
    }
}

function renderGraph(nodes, links) {
    // Clear existing graph
    const container = document.getElementById('graphCanvas');
    container.innerHTML = '';

    const width = document.getElementById('graphContainer').clientWidth;
    const height = 600;

    // Color scale for entity types
    const colorScale = {
        'drug': '#1976d2',
        'disease': '#d32f2f',
        'target': '#f57c00',
        'trial': '#7b1fa2',
        'company': '#00796b',
        'publication': '#c2185b',
        'patent': '#455a64',
        'news': '#0097a7'
    };

    // Create SVG
    graphSvg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .style('background', 'linear-gradient(135deg, #fafafa 0%, #f0f0f5 100%)');

    // Add glow filter
    const defs = graphSvg.append('defs');
    const filter = defs.append('filter')
        .attr('id', 'glow')
        .attr('x', '-50%')
        .attr('y', '-50%')
        .attr('width', '200%')
        .attr('height', '200%');

    filter.append('feGaussianBlur')
        .attr('stdDeviation', '4')
        .attr('result', 'coloredBlur');

    const feMerge = filter.append('feMerge');
    feMerge.append('feMergeNode').attr('in', 'coloredBlur');
    feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

    // Add arrow marker for directed edges
    defs.append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 25)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .append('path')
        .attr('d', 'M 0,-5 L 10,0 L 0,5')
        .attr('fill', '#999')
        .attr('opacity', 0.6);

    // Add zoom behavior
    graphZoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
            graphG.attr('transform', event.transform);
        });

    graphSvg.call(graphZoom);

    // Container for zoom/pan
    graphG = graphSvg.append('g');

    // Create force simulation
    graphSimulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(30));

    // Draw links
    const link = graphG.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('stroke', '#999')
        .attr('stroke-opacity', d => 0.3 + (d.confidence * 0.5))
        .attr('stroke-width', d => 1 + (d.confidence * 2))
        .attr('marker-end', 'url(#arrowhead)')
        .style('transition', 'all 0.3s ease')
        .on('mouseover', function(event, d) {
            d3.select(this)
                .attr('stroke', '#667eea')
                .attr('stroke-width', 4)
                .attr('stroke-opacity', 0.8);
        })
        .on('mouseout', function(event, d) {
            d3.select(this)
                .attr('stroke', '#999')
                .attr('stroke-width', 1 + (d.confidence * 2))
                .attr('stroke-opacity', 0.3 + (d.confidence * 0.5));
        });

    // Draw link labels
    const linkLabel = graphG.append('g')
        .selectAll('text')
        .data(links)
        .join('text')
        .attr('font-size', '10px')
        .attr('fill', '#666')
        .attr('text-anchor', 'middle')
        .text(d => d.predicate);

    // Draw nodes
    const node = graphG.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .call(d3.drag()
            .on('start', dragStarted)
            .on('drag', dragged)
            .on('end', dragEnded))
        .on('click', (event, d) => {
            event.stopPropagation();
            showEntityDetail(d.id, d.name, d.kind);
            switchTab('entities');
        });

    // Node circles
    node.append('circle')
        .attr('r', 12)
        .attr('fill', d => colorScale[d.kind] || '#999')
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .style('cursor', 'pointer')
        .style('filter', 'url(#glow)')
        .style('transition', 'all 0.3s ease')
        .on('mouseover', function(event, d) {
            d3.select(this)
                .attr('r', 16)
                .attr('stroke-width', 3)
                .style('filter', 'url(#glow) brightness(1.2)');
        })
        .on('mouseout', function(event, d) {
            d3.select(this)
                .attr('r', 12)
                .attr('stroke-width', 2)
                .style('filter', 'url(#glow)');
        })
        .append('title')
        .text(d => `${d.name}\n(${d.kind})\nClick for details`);

    // Node labels
    node.append('text')
        .attr('dy', 25)
        .attr('text-anchor', 'middle')
        .attr('font-size', '11px')
        .attr('fill', '#333')
        .attr('pointer-events', 'none')
        .text(d => {
            const maxLen = 20;
            return d.name.length > maxLen ? d.name.substring(0, maxLen) + '...' : d.name;
        });

    // Update positions on tick
    graphSimulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        linkLabel
            .attr('x', d => (d.source.x + d.target.x) / 2)
            .attr('y', d => (d.source.y + d.target.y) / 2);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragStarted(event, d) {
        if (!event.active) graphSimulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragEnded(event, d) {
        if (!event.active) graphSimulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}

function resetGraphZoom() {
    if (graphSvg && graphZoom) {
        graphSvg.transition()
            .duration(750)
            .call(graphZoom.transform, d3.zoomIdentity);
    }
}

document.getElementById('loadEntities').onclick = loadEntitiesHandler;
document.getElementById('loadEdges').onclick = loadEdgesHandler;
document.getElementById('heroSearch').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') performSearch();
});

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/service-worker.js')
            .then(registration => {
                console.log('[PWA] Service Worker registered:', registration.scope);
            })
            .catch(error => {
                console.log('[PWA] Service Worker registration failed:', error);
            });
    });
}

// Load stats on page load
loadStats();

// Initialize library counts
updateLibraryCounts();

// Initial load
loadEntitiesHandler();
</script>
</body>
</html>
