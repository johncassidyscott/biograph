<!DOCTYPE html>
<html>
<head>
    <title>biograph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; display: flex; height: 100vh; background: #f5f5f5; }
        #graph { flex: 1; background: white; }
        .sidebar { width: 320px; background: white; border-left: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        h1 { font-size: 20px; margin-bottom: 10px; }
        button { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: none; border-radius: 4px; background: #3498db; color: white; }
        button:hover { background: #2980b9; }
        .filter { margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; }
        .filter label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .filter input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; }
        .info { background: #f9f9f9; padding: 10px; margin-top: 15px; border-radius: 4px; font-size: 12px; }
        .error { background: #ffe6e6; color: #e74c3c; padding: 10px; border-radius: 4px; }
        .stats { font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="graph"></div>
    <div class="sidebar">
        <h1>biograph</h1>
        <div class="stats" id="stats">Loading...</div>
        <div class="filter">
            <label>Min Score:</label>
            <input type="range" id="scoreSlider" min="0" max="1" step="0.01" value="0" onchange="updateFilter()">
            <span id="scoreValue">0.0</span>
        </div>
        <button onclick="clearAll()" style="background: #95a5a6;">Show All</button>
        <h3 style="margin-top: 20px; font-size: 14px;">Diseases</h3>
        <div id="diseases"></div>
        <div id="info"></div>
    </div>

    <script>
        let fullData = { nodes: [], edges: [] }, filteredData = { nodes: [], edges: [] }, network = null, minScore = 0;
        
        async function load() {
            try {
                const nr = await fetch('/api/graph/nodes');
                if(!nr.ok) throw new Error(`Nodes: ${nr.status}`);
                const nd = await nr.json();
                
                const er = await fetch('/api/graph/edges?min_score=0');
                if(!er.ok) throw new Error(`Edges: ${er.status}`);
                const ed = await er.json();
                
                const colorMap = { disease:'#e74c3c', target:'#3498db', drug:'#2ecc71', patent:'#9b59b6', company:'#f39c12' };
                
                fullData.nodes = nd.nodes.map(n => ({
                    id: n.id,
                    label: n.name,
                    title: `<b>${n.name}</b><br/>${n.canonical_id}`,
                    kind: n.kind,
                    color: colorMap[n.kind] || '#95a5a6',
                    shape: n.kind==='disease'?'diamond'
                         : n.kind==='drug'?'box'
                         : n.kind==='company'?'box'
                         : n.kind==='patent'?'star'
                         : 'dot',
                    size: n.kind==='disease'?35
                        : n.kind==='drug'?30
                        : n.kind==='company'?25
                        : n.kind==='patent'?25
                        : 20
                }));
                
                fullData.edges = ed.edges.map(e => ({
                    from: e.src_id,
                    to: e.dst_id,
                    title: `${e.src_name} â†’ ${e.dst_name} [${e.type}]`,
                    arrows: 'to',
                    width: Math.max(0.5, (e.score || 0) * 5),
                    color: { color: '#cccccc', opacity: Math.max(0.2, (e.score || 0)) },
                    score: e.score || 0
                }));
                
                console.log(`Loaded ${fullData.nodes.length} nodes, ${fullData.edges.length} edges`);
                console.log('Nodes:', fullData.nodes.reduce((a,n)=>{a[n.kind]=(a[n.kind]||0)+1; return a},{}));
                
                const diseases = fullData.nodes.filter(n=>n.kind==='disease').sort((a,b)=>a.label.localeCompare(b.label));
                document.getElementById('diseases').innerHTML = diseases.map(d=>
                    `<button style="background:#e74c3c;margin-top:5px;" onclick="show(${d.id})">${d.label}</button>`
                ).join('');
                
                loadAll();
            } catch(e) {
                console.error(e);
                document.getElementById('stats').innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }
        
        function updateFilter() {
            minScore = parseFloat(document.getElementById('scoreSlider').value);
            document.getElementById('scoreValue').textContent = minScore.toFixed(2);
            loadAll();
        }
        
        function loadAll() {
            filteredData.nodes = fullData.nodes;
            filteredData.edges = fullData.edges.filter(e => e.score >= minScore);
            render(filteredData.nodes, filteredData.edges);
            updateStats();
        }
        
        function show(disease_id) {
            const sub = new Set([disease_id]);
            const sedges = [];
            
            // Get all targets for this disease
            fullData.edges.forEach(e=>{
                if(e.from===disease_id && fullData.nodes.find(n=>n.id===e.to && n.kind==='target')){
                    sub.add(e.to);
                    sedges.push(e);
                }
            });
            
            // Get all drugs for those targets
            fullData.edges.forEach(e=>{
                if(fullData.nodes.find(n=>n.id===e.from && n.kind==='drug') && sub.has(e.to)){
                    sub.add(e.from);
                    sedges.push(e);
                }
            });
            
            // Get companies for those drugs
            fullData.edges.forEach(e=>{
                if(fullData.nodes.find(n=>n.id===e.from && n.kind==='drug') && fullData.nodes.find(n=>n.id===e.to && n.kind==='company')){
                    if(sub.has(e.from)){
                        sub.add(e.to);
                        sedges.push(e);
                    }
                }
            });
            
            const snodes = fullData.nodes.filter(n=>sub.has(n.id));
            render(snodes, sedges);
            updateStats(snodes.length, sedges.length);
        }
        
        function render(n, e) {
            if(network) network.destroy();
            network = new vis.Network(document.getElementById('graph'), {nodes:n,edges:e}, {
                physics: { enabled: false },
                layout: { hierarchical: { enabled: true, direction: 'LR', nodeSpacing: 150, levelSeparation: 300 } },
                interaction: { navigationButtons: true, keyboard: true }
            });
            network.on('click', p=>{if(p.nodes.length>0){const nd=fullData.nodes.find(x=>x.id===p.nodes[0]);if(nd)show_info(nd);}});
        }
        
        function show_info(n) {
            const ec = fullData.edges.filter(e=>e.from===n.id||e.to===n.id).length;
            document.getElementById('info').innerHTML = `<div class="info"><b>${n.label}</b><br/>Type: ${n.kind}<br/>Connections: ${ec}</div>`;
        }
        
        function updateStats(nc=null,ec=null) {
            if(!nc) { nc = filteredData.nodes.length; ec = filteredData.edges.length; }
            const d=filteredData.nodes.filter(n=>n.kind==='disease').length,
                  t=filteredData.nodes.filter(n=>n.kind==='target').length,
                  dr=filteredData.nodes.filter(n=>n.kind==='drug').length,
                  c=filteredData.nodes.filter(n=>n.kind==='company').length,
                  p=filteredData.nodes.filter(n=>n.kind==='patent').length;
            document.getElementById('stats').innerHTML=`<strong>Nodes:</strong> ${nc}<br/><strong>Edges:</strong> ${ec}<br/><strong>Diseases:</strong> ${d}<br/><strong>Targets:</strong> ${t}<br/><strong>Drugs:</strong> ${dr}<br/><strong>Companies:</strong> ${c}<br/><strong>Patents:</strong> ${p}`;
        }
        
        function clearAll() {
            document.getElementById('info').innerHTML = '';
            loadAll();
        }
        
        window.addEventListener('load', load);
    </script>
</body>
</html>
